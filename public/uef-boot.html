<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>UEF Boot</title>
  </head>
  <body>
    <script>
      /**
       * This page is the entry point used by your placement URL.
       * It captures the Learn OAuth2 tokens from the redirect query params,
       * stores them, then loads /uef.js which connects to Ultra via postMessage.
       */

      const qs = new URLSearchParams(location.search);

      // Backwards compatible: accept either token= or access_token=
      const accessToken = qs.get("token") || qs.get("access_token") || "";
      const refreshToken = qs.get("refresh_token") || "";
      const expiresIn = Number(qs.get("expires_in") || "0"); // seconds
      const learnHost = qs.get("learn") || "";

      if (learnHost) {
        // Used by uef.js for postMessage origin matching
        localStorage.setItem("UEF_LEARN_HOST", learnHost);
        window.__learnHost = learnHost;
      }

      if (accessToken) {
        // Keep the legacy key (if any code depends on it)
        localStorage.setItem("UEF_BEARER_TOKEN", accessToken);

        // The key uef.js uses
        localStorage.setItem("uef_user_token", accessToken);
        window.__token = accessToken;
      }

      if (refreshToken) {
        localStorage.setItem("uef_refresh_token", refreshToken);
      }

      if (expiresIn > 0) {
        const expiresAt = Date.now() + expiresIn * 1000;
        localStorage.setItem("uef_token_expires_at", String(expiresAt));
      }

      // Load the integration script (cache-bust to avoid stale JS during dev)
      const s = document.createElement("script");
      s.src = `/uef.js?v=${Date.now()}`;
      document.body.appendChild(s);
    </script>
  </body>
</html>
